#!/bin/sh

set -e

export BUILD_DIR=$1
bp_dir=$(cd "$(dirname "$0")"; cd ..; pwd)

# exit if no git submodules are present
if [ ! -f "$BUILD_DIR/.gitmodules" ]; then
  echo "-----> No .gitmodules file found. Skipping."
  exit 0
fi

# install git submodules
while IFS= read -r line; do
  if echo "$line" | grep -q '^\[submodule'; then
    read -r path_line
    path=$(echo "$path_line" | awk -F ' = ' '{print $2}')
    read -r url_line
    url=$(echo "$url_line" | awk -F ' = ' '{print $2}')
    branch=""
    revision=""

    while IFS= read -r sub_line && ! echo "$sub_line" | grep -q '^\[submodule'; do
      case "$sub_line" in
        *branch*)
          branch=$(echo "$sub_line" | awk -F ' = ' '{print $2}')
          ;;
        *revision*)
          revision=$(echo "$sub_line" | awk -F ' = ' '{print $2}')
          ;;
      esac
    done

    echo "-----> Installing submodule $path $branch"
    branch_flag=""
    [ -n "$branch" ] && branch_flag="-b $branch"

    build_path="$BUILD_DIR/$path"
    git clone -q --single-branch "$url" $branch_flag "$build_path"

    if [ -n "$revision" ]; then
      echo "       Setting submodule revision to $revision"
      (
        cd "$build_path"
        git reset --hard "$revision"
      )
    fi

    echo "       Removing submodule git folder"
    rm -rf "$build_path/.git"
  fi
done < "$BUILD_DIR/.gitmodules"
